# SPNEGO Testing Environment for om CLI

This directory contains a Docker-based testing environment for SPNEGO (Kerberos) proxy authentication support in the `om` CLI.

## Overview

The test environment consists of:
- **Kerberos KDC** (Key Distribution Center) - MIT Kerberos server for authentication
- **Apache Proxy** - HTTP proxy with `mod_auth_gssapi` for SPNEGO authentication
- **Test Scripts** - Automated setup and testing

This setup allows testing `om` CLI commands through a Kerberos-authenticated proxy without needing access to a production environment.

## Prerequisites

- Docker and Docker Compose installed
- `kinit` and `klist` utilities (for manual testing)
- Go 1.23+ (for building `om`)

On macOS:
```bash
brew install docker docker-compose
# kinit/klist come with macOS
```

## Quick Start

### 1. Start Docker Containers

```bash
cd test-integration
docker-compose up -d
```

This starts:
- `test-kerberos-kdc` on port 88 (Kerberos)
- `test-apache-proxy` on port 3128 (HTTP proxy)

Verify containers are running:
```bash
docker ps
```

### 2. Setup Kerberos Principals

The KDC starts empty, so you need to create test principals:

```bash
./setup-kerberos-principals.sh
```

This creates:
- **User principal**: `testuser@TEST.LOCAL` (password: `testpass123`)
- **Service principals**: `HTTP/localhost@TEST.LOCAL`, `HTTP/proxy.test.local@TEST.LOCAL`
- **Keytab**: Exported and installed in the proxy container

### 3. Run the Test Script

```bash
./test-om-spnego.sh
```

This script:
1. Checks that Docker containers are running
2. Builds the `om` CLI binary
3. Attempts to run `om products` with SPNEGO flags:
   - `--proxy-username testuser`
   - `--proxy-password testpass123`
   - `--proxy-domain TEST.LOCAL`

**Expected Result (before implementation):**
```
unknown flag '--proxy-username'
```

This confirms the test environment is working and ready for SPNEGO implementation.

**Expected Result (after implementation):**
The command should authenticate through the proxy and attempt to connect to the Ops Manager target.

## Manual Testing

### Test Kerberos Authentication

```bash
# Set Kerberos config
export KRB5_CONFIG=./krb5-host.conf

# Get a ticket
kinit testuser@TEST.LOCAL
# Password: testpass123

# Verify ticket
klist

# Should show:
# Ticket cache: FILE:/tmp/krb5cc_...
# Default principal: testuser@TEST.LOCAL
```

### Test Proxy with curl

```bash
export KRB5_CONFIG=./krb5-host.conf
export http_proxy=http://localhost:3128
export https_proxy=http://localhost:3128

# Authenticate first
kinit testuser@TEST.LOCAL

# Test proxy (should work after kinit)
curl --proxy-negotiate -u : http://example.com
```

## Directory Structure

```
test-integration/
├── docker-compose.yml              # Docker services definition
├── Dockerfile.apache-spnego        # Apache proxy with SPNEGO
├── setup-kerberos-principals.sh    # Principal setup script
├── test-om-spnego.sh              # Main test script
├── krb5-host.conf                 # Kerberos config (host machine)
├── krb5-docker.conf               # Kerberos config (Docker containers)
├── proxy.keytab                   # Service keytab (regenerated by setup)
├── apache-config/
│   ├── apache-spnego.conf         # Apache proxy configuration
│   └── ports.conf                 # Apache port settings
└── kerberos-config/               # Optional KDC config overrides
```

## Configuration

### Kerberos Realm
- **Realm**: `TEST.LOCAL`
- **KDC**: `localhost:88` (from host), `test-kerberos-kdc:88` (from Docker)
- **Admin Server**: `localhost:749`

### Test Credentials
- **Username**: `testuser`
- **Password**: `testpass123`
- **Domain**: `TEST.LOCAL`
- **Principal**: `testuser@TEST.LOCAL`

### Proxy
- **URL**: `http://localhost:3128`
- **Auth Type**: SPNEGO/Kerberos
- **Service Principal**: `HTTP/localhost@TEST.LOCAL`

## Troubleshooting

### Containers won't start

```bash
# Check logs
docker logs test-kerberos-kdc
docker logs test-apache-proxy

# Restart containers
docker-compose down
docker-compose up -d
```

### "Principal already exists" errors

This is normal if you've run `setup-kerberos-principals.sh` before. The script will reuse existing principals.

### kinit fails with "Cannot find KDC"

```bash
# Verify KDC is running
docker ps | grep test-kerberos-kdc

# Check network connectivity
nc -zv localhost 88

# Verify KRB5_CONFIG is set
echo $KRB5_CONFIG
# Should show: ./krb5-host.conf (or full path)
```

### Proxy authentication fails (HTTP 407)

```bash
# Check keytab is installed
docker exec test-apache-proxy ls -la /etc/apache2/proxy.keytab

# View proxy logs
docker logs test-apache-proxy

# Re-run principal setup
./setup-kerberos-principals.sh
```

### om test fails unexpectedly

```bash
# Check that SPNEGO flags are being passed
cat /tmp/om-spnego-output.log

# Verify environment variables
echo $HTTP_PROXY
echo $HTTPS_PROXY
echo $KRB5_CONFIG

# Try manual kinit
KRB5_CONFIG=./krb5-host.conf kinit testuser@TEST.LOCAL
klist
```

## Cleanup

### Stop containers (keep data)
```bash
docker-compose stop
```

### Remove containers and networks
```bash
docker-compose down
```

### Clean rebuild
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
./setup-kerberos-principals.sh
```

## Next Steps

After the test environment is verified:

1. **Implement SPNEGO support** in `om` CLI:
   - Add `--proxy-username`, `--proxy-password`, `--proxy-domain` global flags
   - Implement Kerberos authentication (similar to `tpi-telemetry-cli`)
   - Use shell-out approach: `kinit` + `curl --negotiate`

2. **Update test script** to verify actual SPNEGO authentication:
   - After implementation, the test should succeed (not fail with "unknown flag")
   - Add checks for successful proxy authentication
   - Test against a real or mock Ops Manager endpoint

3. **Add integration tests** for different scenarios:
   - Valid credentials
   - Invalid credentials
   - Missing credentials
   - Proxy unavailable
   - KDC unavailable

## References

- [MIT Kerberos Documentation](https://web.mit.edu/kerberos/krb5-latest/doc/)
- [Apache mod_auth_gssapi](https://github.com/gssapi/mod_auth_gssapi)
- [SPNEGO HTTP Auth](https://tools.ietf.org/html/rfc4559)
- `tpi-telemetry-cli` SPNEGO implementation (reference for `om` implementation)


